<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Мой маршрут Тбилиси</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.css" />
  <style>
    html, body, #map { height: 100%; margin: 0; padding: 0; }
  </style>
</head>
<body>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/@tmcw/togeojson@5.8.0/dist/togeojson.umd.js"></script>
<script src="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.js"></script>
<script>
  // --- Внешние иконки (классические булавки разных цветов) ---
  // источник: https://cdn.jsdelivr.net/gh/pointhi/leaflet-color-markers
  const SHADOW = "https://cdn.jsdelivr.net/gh/pointhi/leaflet-color-markers@v1.0/img/marker-shadow.png";
  const IconBlue   = L.icon({ iconUrl: "https://cdn.jsdelivr.net/gh/pointhi/leaflet-color-markers@v1.0/img/marker-icon-2x-blue.png",   shadowUrl: SHADOW, iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[1,-34], shadowSize:[41,41] });
  const IconRed    = L.icon({ iconUrl: "https://cdn.jsdelivr.net/gh/pointhi/leaflet-color-markers@v1.0/img/marker-icon-2x-red.png",    shadowUrl: SHADOW, iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[1,-34], shadowSize:[41,41] });
  const IconGreen  = L.icon({ iconUrl: "https://cdn.jsdelivr.net/gh/pointhi/leaflet-color-markers@v1.0/img/marker-icon-2x-green.png",  shadowUrl: SHADOW, iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[1,-34], shadowSize:[41,41] });
  const IconYellow = L.icon({ iconUrl: "https://cdn.jsdelivr.net/gh/pointhi/leaflet-color-markers@v1.0/img/marker-icon-2x-yellow.png", shadowUrl: SHADOW, iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[1,-34], shadowSize:[41,41] });

  // --- Безопасная нормализация текста из свойств (строка/массив/объект -> строка) ---
  function normText(v) {
    if (v == null) return "";
    if (typeof v === "string") return v;
    if (Array.isArray(v)) return v.map(normText).join(" ");
    if (typeof v === "object") return Object.values(v).map(normText).join(" ");
    return String(v);
  }

  function getIconForFeature(feature) {
    const name = normText(feature?.properties?.name).toLowerCase();
    const desc = normText(feature?.properties?.description).toLowerCase();

    if (name.includes("лестниц") || desc.includes("лестниц")) return IconGreen;        // лестницы
    if (name.includes("парадн")  || desc.includes("парадн"))  return IconRed;          // парадные
    if (name.includes("обсерватор") || desc.includes("обсерватор") ||
        name.includes("apollo") || desc.includes("аполло"))    return IconYellow;      // особые
    return IconBlue; // остальное
  }

  // --- Карта ---
  const map = L.map('map');
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19, attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  L.control.locate({
    position:'topleft', setView:'untilPan', keepCurrentZoomLevel:true,
    strings:{ title:'Показать моё местоположение' }
  }).addTo(map);

  // --- Загрузка KML рядом как doc.kml ---
  fetch('doc.kml')
    .then(r => {
      if (!r.ok) throw new Error('HTTP ' + r.status);
      return r.text();
    })
    .then(kmlText => {
      const kmlXml  = new DOMParser().parseFromString(kmlText, 'application/xml');
      const geojson = toGeoJSON.kml(kmlXml);

      const layer = L.geoJSON(geojson, {
        pointToLayer: (feature, latlng) => L.marker(latlng, { icon: getIconForFeature(feature) }),
        style: { weight: 3 },
        onEachFeature: (feature, layer) => {
          const p = feature.properties || {};
          layer.bindPopup(`<strong>${normText(p.name)}</strong><br>${normText(p.description)}`);
        }
      }).addTo(map);

      try { map.fitBounds(layer.getBounds(), { padding:[20,20] }); }
      catch { map.setView([41.6938, 44.8015], 14); }
    })
    .catch(err => {
      console.error('KML load error:', err);
      map.setView([41.6938, 44.8015], 14);
      alert('Не удалось загрузить doc.kml. Проверь путь/имя файла.');
    });
</script>

</body>
</html>
