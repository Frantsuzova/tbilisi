<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Мой маршрут Тбилиси</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.css" />
  <style>
    html, body, #map { height: 100%; margin: 0; padding: 0; }
  </style>
</head>
<body>
  <div id="map"></div>

<script>
  // Фолбэк-иконка, если у вас нет функции getIconForFeature
  const SHADOW="https://cdn.jsdelivr.net/gh/pointhi/leaflet-color-markers@v1.0/img/marker-shadow.png";
  const IconBlue = L.icon({iconUrl:"https://cdn.jsdelivr.net/gh/pointhi/leaflet-color-markers@v1.0/img/marker-icon-2x-blue.png",
    shadowUrl:SHADOW, iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[1,-34], shadowSize:[41,41] });

  function normText(v){ if(v==null)return ""; if(typeof v==="string")return v;
    if(Array.isArray(v))return v.map(normText).join(" "); if(typeof v==="object")return Object.values(v).map(normText).join(" "); return String(v); }

  function renderGeoJSON(geojson){
    // стабилизируем порядок на случай ваших правил иконок по индексу
    if(Array.isArray(geojson.features)){
      geojson.features.forEach((f,i)=>{ f.properties = Object.assign({}, f.properties, {_seq:i}); });
    }
    const pickIcon = (f) =>
      (typeof window.chooseIconForFeature === 'function' && window.chooseIconForFeature(f)) ||
      (typeof window.getIconForFeature === 'function' && window.getIconForFeature(f)) ||
      IconBlue;

    const layer = L.geoJSON(geojson, {
      pointToLayer: (feature, latlng) => L.marker(latlng, { icon: pickIcon(feature) }),
      style: { weight: 3 },
      onEachFeature: (feature, layer) => {
        const p = feature.properties || {};
        layer.bindPopup(`<strong>${normText(p.name)}</strong><br>${normText(p.description)}`);
      }
    }).addTo(map);

    try { map.fitBounds(layer.getBounds(), { padding:[20,20] }); }
    catch { map.setView([41.6938,44.8015],14); }
  }

  async function loadKmlFromUrl(url){
    const r = await fetch(url, { cache: 'no-store' });
    if(!r.ok) throw new Error('HTTP '+r.status);
    const kmlText = await r.text();
    const kmlXml  = new DOMParser().parseFromString(kmlText,'application/xml');
    const geojson = toGeoJSON.kml(kmlXml);
    renderGeoJSON(geojson);
  }

  function enableKmlPicker(){
    const bar = document.createElement('div');
    bar.style.cssText = 'position:absolute;z-index:1000;left:10px;top:10px;background:#fff;padding:8px 10px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.15);display:flex;gap:8px;align-items:center;font:14px system-ui';
    bar.innerHTML = `
      <span>Загрузить KML:</span>
      <input type="file" id="kmlFile" accept=".kml,.xml">
      <input type="text" id="kmlUrl" placeholder="или URL..." style="width:240px">
      <button id="kmlLoadBtn">Загрузить</button>
    `;
    document.body.appendChild(bar);

    bar.querySelector('#kmlFile').addEventListener('change', (e)=>{
      const f = e.target.files?.[0]; if(!f) return;
      const fr = new FileReader();
      fr.onload = () => {
        const kmlXml  = new DOMParser().parseFromString(String(fr.result),'application/xml');
        const geojson = toGeoJSON.kml(kmlXml);
        renderGeoJSON(geojson);
        bar.remove();
      };
      fr.readAsText(f);
    });

    bar.querySelector('#kmlLoadBtn').addEventListener('click', async ()=>{
      const url = bar.querySelector('#kmlUrl').value.trim();
      if(!url) return;
      try { await loadKmlFromUrl(url); bar.remove(); }
      catch(e){ alert('Не удалось загрузить KML по URL'); console.error(e); }
    });
  }

  // --- Пытаемся взять ./doc.kml из корня. Если нет — даём выбрать вручную.
  (async ()=>{
    try {
      const urlParam = new URLSearchParams(location.search).get('kml');
      await loadKmlFromUrl(urlParam || './doc.kml');
    } catch(e){
      console.warn('KML not found, enabling picker:', e);
      enableKmlPicker();
      // Базовый вид, чтобы карта не была пустой
      try { map.setView([41.6938,44.8015],14); } catch {}
    }
  })();
</script>



</body>
</html>
