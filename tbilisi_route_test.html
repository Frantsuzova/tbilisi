<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Мой маршрут Тбилиси</title>

  <!-- CSP: разрешаем inline CSS/JS, блокируем посторонние IMG -->
  <meta http-equiv="Content-Security-Policy"
        content="
          default-src 'self' https: data:;
          script-src  'self' https: 'unsafe-inline';
          style-src   'self' https: 'unsafe-inline';
          img-src     'self' data: https://cdn.jsdelivr.net https://unpkg.com https://*.tile.openstreetmap.org https://*.basemaps.cartocdn.com;
        ">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.css" />

  <style>
    :root{
      --panel-bg: rgba(255,255,255,.78);
      --panel-border: rgba(0,0,0,.1);
      --text: #0f172a;
      --muted: #475569;
      --chip-bg: rgba(15,23,42,.06);
      --chip-active: #2563eb;
      --shadow: 0 8px 24px rgba(0,0,0,.18);
      --radius: 16px;
      --accent: #0ea5e9;
    }
    @media (prefers-color-scheme: dark){
      :root{
        --panel-bg: rgba(17,24,39,.72);
        --panel-border: rgba(255,255,255,.08);
        --text: #e5e7eb;
        --muted: #94a3b8;
        --chip-bg: rgba(255,255,255,.06);
        --chip-active: #60a5fa;
        --shadow: 0 8px 24px rgba(0,0,0,.4);
        --accent: #22d3ee;
      }
    }

    html, body, #map { height: 100%; margin: 0; padding: 0; }
    body { color: var(--text); font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; }

    .panel{
      position: absolute;
      backdrop-filter: blur(8px) saturate(1.2);
      -webkit-backdrop-filter: blur(8px) saturate(1.2);
      background: var(--panel-bg);
      border: 1px solid var(--panel-border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }

    .panel-header{
      top: 16px; left: 16px; right: 360px;
      padding: 12px 14px;
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 10px 12px;
      align-items: center;
    }
    .title{ font-weight: 700; letter-spacing:.2px; }
    .subtitle{ color: var(--muted); font-size: 12px; }
    .actions{ display:flex; gap:8px; align-items:center; }
    .btn{
      border:1px solid var(--panel-border);
      background: var(--chip-bg);
      border-radius: 999px;
      padding: 6px 10px;
      cursor: pointer;
      color: var(--text);
      transition: .15s ease;
      user-select: none;
    }
    .btn:hover{ transform: translateY(-1px); }
    .btn-primary{ background: var(--accent); color:#04121a; border-color: transparent; }
    .btn-primary:hover{ filter: brightness(1.05); }

    .filters{ grid-column: 1 / -1; display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .search{
      min-width: 220px; flex:1 1 260px;
      border:1px solid var(--panel-border);
      background: var(--chip-bg);
      border-radius: 10px;
      padding: 8px 10px;
      color:var(--text);
      outline:none;
    }
    .chip{
      border:1px solid var(--panel-border);
      background: var(--chip-bg);
      border-radius: 999px;
      padding: 6px 10px;
      cursor:pointer;
      font-size: 12px;
    }
    .chip[data-active="true"]{ background: var(--chip-active); color:#031018; border-color: transparent; }

    .panel-sidebar{
      top: 16px; right: 16px; bottom: 16px; width: 320px;
      display:flex; flex-direction:column;
      overflow:hidden;
    }
    .sidebar-head{ padding: 12px 14px; border-bottom:1px solid var(--panel-border); display:flex; justify-content:space-between; align-items:center; }
    .sidebar-title{ font-weight:600; }
    .sidebar-body{ padding: 8px 8px 12px; overflow:auto; }
    .item{
      display:grid; grid-template-columns: 1fr auto; gap:4px 8px;
      padding:10px 10px; border-radius:12px; border:1px solid var(--panel-border); background: rgba(0,0,0,.03);
      margin-bottom:8px; cursor:pointer;
    }
    @media (prefers-color-scheme: dark){ .item{ background: rgba(255,255,255,.04); } }
    .item h4{ margin:0; font-size: 13px; font-weight:600; }
    .item .meta{ grid-column:1/-1; color:var(--muted); font-size:12px; }
    .item .fly{ align-self:start; }

    .panel-legend{
      left:16px; bottom:16px; max-width: 420px; padding:10px 12px; display:flex; gap:12px; align-items:center; flex-wrap:wrap;
    }
    .legend-group{ display:flex; gap:10px; flex-wrap:wrap; }
    .legend{
      display:flex; gap:6px; align-items:center; background: var(--chip-bg); border:1px solid var(--panel-border);
      padding:6px 10px; border-radius:999px; font-size:12px;
    }
    .legend img{ width:18px; height:18px; display:block; }

    .count{ font-variant-numeric: tabular-nums; }
    .hidden{ display:none !important; }

    /* Если IMG просочится в попап — глушим */
    .leaflet-popup-content img { display:none !important; max-width:0 !important; max-height:0 !important; }

    /* Поверх карты и контролов */
    .panel { z-index: 1200; }
    .leaflet-top, .leaflet-bottom { z-index: 1100; }
    #map { position: relative; z-index: 0; }

    @media (max-width: 980px){
      .panel-header{ right: 16px; }
      .panel-sidebar{ width: 300px; }
    }
    @media (max-width: 780px){
      .panel-header{ right: 16px; grid-template-columns: 1fr; }
      .actions{ justify-content:flex-start; }
      .panel-sidebar{ position: fixed; left: 16px; right:16px; width:auto; height: 42vh; top: auto; }
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Шапка -->
  <div class="panel panel-header" id="headerPanel">
    <div>
      <div class="title">Мой маршрут Тбилиси</div>
      <div class="subtitle"><span class="count" id="countTotal">0</span> точек · <span class="count" id="countCat"></span></div>
    </div>
    <div class="actions">
      <button class="btn" id="btnShowAll" title="Показать все точки">Показать всё</button>
      <button class="btn btn-primary" id="btnLocate" title="Моё местоположение">Моё место</button>
    </div>
    <div class="filters">
      <input id="search" class="search" type="search" placeholder="Поиск по названию/описанию…" />
      <button class="chip" data-cat="all" data-active="true">Все</button>
      <button class="chip" data-cat="stairs">Лестницы</button>
      <button class="chip" data-cat="porches">Парадные</button>
      <button class="chip" data-cat="special">Особые</button>
      <button class="chip" data-cat="other">Прочее</button>
    </div>
  </div>

  <!-- Сайдбар -->
  <aside class="panel panel-sidebar" id="sidebar">
    <div class="sidebar-head">
      <div class="sidebar-title">Точки маршрута</div>
      <button class="btn" id="btnToggleSidebar">Свернуть</button>
    </div>
    <div class="sidebar-body" id="list"></div>
  </aside>

  <!-- Легенда -->
  <div class="panel panel-legend">
    <div class="legend-group" id="legend"></div>
  </div>

  <!-- JS-библиотеки -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/@tmcw/togeojson@5.8.0/dist/togeojson.umd.js"></script>
  <script src="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.js"></script>

  <!-- Логика -->
  <script>
    /* Фолбэк-булавки */
    const SHADOW = "https://cdn.jsdelivr.net/gh/pointhi/leaflet-color-markers@v1.0/img/marker-shadow.png";
    const IconBlue   = L.icon({ iconUrl: "https://cdn.jsdelivr.net/gh/pointhi/leaflet-color-markers@v1.0/img/marker-icon-2x-blue.png",   shadowUrl: SHADOW, iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[1,-34], shadowSize:[41,41] });
    const IconRed    = L.icon({ iconUrl: "https://cdn.jsdelivr.net/gh/pointhi/leaflet-color-markers@v1.0/img/marker-icon-2x-red.png",    shadowUrl: SHADOW, iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[1,-34], shadowSize:[41,41] });
    const IconGreen  = L.icon({ iconUrl: "https://cdn.jsdelivr.net/gh/pointhi/leaflet-color-markers@v1.0/img/marker-icon-2x-green.png",  shadowUrl: SHADOW, iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[1,-34], shadowSize:[41,41] });
    const IconYellow = L.icon({ iconUrl: "https://cdn.jsdelivr.net/gh/pointhi/leaflet-color-markers@v1.0/img/marker-icon-2x-yellow.png", shadowUrl: SHADOW, iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[1,-34], shadowSize:[41,41] });

    /* Персональные PNG */
    const ICONS = { prefix: 'icon-', ext: 'png', count: 28, size: [32,32], anchor: [16,32], popupAnchor: [0,-28] };
    const iconCache = new Map();
    function personalIcon(id){
      if (!id || id < 1 || id > ICONS.count) return null;
      if (iconCache.has(id)) return iconCache.get(id);
      const ic = L.icon({ iconUrl: `${ICONS.prefix}${id}.${ICONS.ext}`, iconSize: ICONS.size, iconAnchor: ICONS.anchor, popupAnchor: ICONS.popupAnchor });
      iconCache.set(id, ic); return ic;
    }
    const imgExistsCache = new Map();
    function imageExists(url){
      if (imgExistsCache.has(url)) return imgExistsCache.get(url);
      const p = new Promise(res=>{
        const im = new Image();
        im.onload = ()=>res(true);
        im.onerror = ()=>res(false);
        im.src = url + (url.includes('?')?'&':'?') + 'v=' + Date.now();
      }).then(ok=>{ imgExistsCache.set(url, ok); return ok; });
      imgExistsCache.set(url, p); return p;
    }

    /* Утилиты */
    const normText = v => v==null ? "" : (typeof v==="string" ? v : Array.isArray(v) ? v.map(normText).join(" ") : (typeof v==="object" ? Object.values(v).map(normText).join(" ") : String(v)));
    function sanitizeKmlString(txt){
      return String(txt)
        .replace(/<img\b[^>]*>/gi, '')
        .replace(/url\((['"]?)https?:\/\/mymaps\.usercontent\.google\.com\/[^)]+?\1\)/gi, 'none')
        .replace(/<\/?(?:iframe|audio|video|source|script)\b[^>]*>/gi, '');
    }
    function stripHtmlToText(html) {
      const tmp = document.createElement('div');
      tmp.innerHTML = String(html || '');
      tmp.querySelectorAll('img, picture, source, iframe, video, audio, svg').forEach(el => el.remove());
      return (tmp.textContent || '').replace(/\s+\n/g, '\n').replace(/\s{2,}/g, ' ').trim();
    }
    function escapeHtml(s) {
      return String(s || '')
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#39;");
    }
    function makePopupHtml(name, description) {
      const nameText = escapeHtml(normText(name)) || 'Без названия';
      const descText = stripHtmlToText(description);
      return descText ? `<strong>${nameText}</strong><br>${escapeHtml(descText)}`
                      : `<strong>${nameText}</strong>`;
    }
    function detectCategory(p){
      const name = normText(p?.name).toLowerCase();
      const desc = normText(p?.description).toLowerCase();
      if (name.includes("лестниц") || desc.includes("лестниц")) return "stairs";
      if (name.includes("парадн")  || desc.includes("парадн"))  return "porches";
      if (name.includes("обсерватор") || desc.includes("обсерватор") || name.includes("apollo") || name.includes("аполло")) return "special";
      return "other";
    }
    const CAT_LABEL = { stairs:"Лестницы", porches:"Парадные", special:"Особые", other:"Прочее" };

    /* KML стили */
    const HREF_TO_ID = Object.create(null);
    function idFromHref(href){
      if (!href) return null;
      if (HREF_TO_ID[href]) return HREF_TO_ID[href];
      const fn = href.split('?')[0].split('#')[0].split('/').pop() || "";
      const m = fn.match(/(?:^|[^\d])([1-9]\d{0,2})(?=\D|$)/);
      if (!m) return null;
      const n = parseInt(m[1], 10);
      return (n>=1 && n<=ICONS.count) ? n : null;
    }
    function buildStyleHrefMap(kmlXml){
      const byId = Object.create(null);
      kmlXml.querySelectorAll('Style[id]').forEach(st=>{
        const id = st.getAttribute('id');
        const href = st.querySelector('IconStyle Icon href')?.textContent?.trim();
        if (id && href) byId['#'+id] = href;
      });
      kmlXml.querySelectorAll('StyleMap[id]').forEach(sm=>{
        const id = sm.getAttribute('id');
        let href = null, target = null;
        sm.querySelectorAll('Pair').forEach(p=>{
          const key = p.querySelector('key')?.textContent?.trim();
          if (!target && key === 'normal') target = p;
        });
        if (!target) target = sm.querySelector('Pair');
        if (target){
          const styleUrl = target.querySelector('styleUrl')?.textContent?.trim();
          if (styleUrl && byId[styleUrl]) href = byId[styleUrl];
        }
        if (!href){
          const innerHref = sm.querySelector('IconStyle Icon href')?.textContent?.trim();
          if (innerHref) href = innerHref;
        }
        if (id && href) byId['#'+id] = href;
      });
      return byId;
    }

    /* Карта и тайлы (светлая/тёмная) */
    const map = L.map('map', { zoomControl:false });
    const tilesLight = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      subdomains: 'abcd', maxZoom: 20, attribution: '&copy; OpenStreetMap contributors &copy; CARTO'
    });
    const tilesDark  = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
      subdomains: 'abcd', maxZoom: 20, attribution: '&copy; OpenStreetMap contributors &copy; CARTO'
    });
    let currentTiles = null;
    function setTilesByColorScheme(){
      const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      const next = prefersDark ? tilesDark : tilesLight;
      if (currentTiles !== next){
        if (currentTiles) map.removeLayer(currentTiles);
        next.addTo(map);
        currentTiles = next;
      }
    }
    setTilesByColorScheme();
    if (window.matchMedia) {
      const mm = window.matchMedia('(prefers-color-scheme: dark)');
      if (mm.addEventListener) mm.addEventListener('change', setTilesByColorScheme);
      else if (mm.addListener) mm.addListener(setTilesByColorScheme);
    }
    L.control.zoom({ position:'topright' }).addTo(map);
    L.control.scale({ imperial:false }).addTo(map);
    const locateCtrl = L.control.locate({ position:'topright', setView:'untilPan', keepCurrentZoomLevel:true, strings:{ title:'Показать моё местоположение' } }).addTo(map);

    /* Данные/слои */
    let geoLayer = null;
    const markersById = new Map();
    let boundsAll = null;
    let allFeatures = [];

    function computeIconId(feature, styleHrefMap){
      const p = feature.properties || {};
      const href = typeof p.styleUrl === 'string' ? (styleHrefMap[p.styleUrl] || null) : null;
      const idFromKml = idFromHref(href);
      if (idFromKml) return idFromKml;
      const seq = Number.isFinite(p._seq) ? p._seq : 0;
      return ((seq % ICONS.count) + 1);
    }

    function renderGeoJSON(geojson, styleHrefMap){
      if (Array.isArray(geojson.features)) {
        geojson.features.forEach((f,i)=>{ f.properties = { ...(f.properties||{}), _seq:i }; });
      }
      allFeatures = geojson.features || [];

      geoLayer = L.geoJSON(geojson, {
        pointToLayer: (feature, latlng) => {
          const marker = L.marker(latlng, { icon: IconBlue });
          const id = computeIconId(feature, styleHrefMap);
          const url = `${ICONS.prefix}${id}.${ICONS.ext}`;
          imageExists(url).then(ok => { if (ok) marker.setIcon(personalIcon(id)); });
          markersById.set(feature.properties._seq, marker);
          marker.featureCat = detectCategory(feature.properties);
          marker.featureProps = feature.properties;
          return marker;
        },
        onEachFeature: (feature, layer) => {
          const p = feature.properties || {};
          layer.bindPopup(makePopupHtml(p.name, p.description));
        }
      }).addTo(map);

      try { boundsAll = geoLayer.getBounds(); if (boundsAll.isValid()) map.fitBounds(boundsAll, { padding:[20,20] }); }
      catch { map.setView([41.6938,44.8015], 14); }

      updateCounters();
      buildList();
      buildLegend();
    }

    function updateCounters(){
      const total = allFeatures.length;
      const cats = { stairs:0, porches:0, special:0, other:0 };
      allFeatures.forEach(f => { cats[detectCategory(f.properties)]++; });
      document.getElementById('countTotal').textContent = total;
      document.getElementById('countCat').textContent =
        `лестницы ${cats.stairs}, парадные ${cats.porches}, особые ${cats.special}, прочее ${cats.other}`;
    }

    function buildLegend(){
      const el = document.getElementById('legend');
      el.innerHTML = '';
      const items = [
        { label:'Лестницы', icon: IconGreen.options.iconUrl },
        { label:'Парадные', icon: IconRed.options.iconUrl },
        { label:'Особые',   icon: IconYellow.options.iconUrl },
        { label:'Прочее',   icon: IconBlue.options.iconUrl },
      ];
      items.forEach(it=>{
        const box = document.createElement('div');
        box.className = 'legend';
        box.innerHTML = `<img src="${it.icon}" alt=""><span>${it.label}</span>`;
        el.appendChild(box);
      });
    }

    function buildList(){
      const list = document.getElementById('list');
      list.innerHTML = '';
      allFeatures.forEach(f=>{
        const p = f.properties || {};
        const seq = p._seq;
        const cat = detectCategory(p);

        const item = document.createElement('div');
        item.className = 'item';
        item.dataset.cat = cat;

        item.innerHTML = `
          <h4>${escapeHtml(normText(p.name) || 'Без названия')}</h4>
          <button class="btn fly">К точке</button>
          <div class="meta"></div>
        `;
        const meta = item.querySelector('.meta');
        const descText = stripHtmlToText(p.description);
        const short = descText.length > 180 ? descText.slice(0, 180) + '…' : descText;
        meta.textContent = `${CAT_LABEL[cat]} · ${short}`;

        item.addEventListener('click', ()=>{
          const m = markersById.get(seq);
          if (!m) return;
          map.flyTo(m.getLatLng(), Math.max(map.getZoom(), 17), { duration: .8 });
          setTimeout(()=>m.openPopup(), 850);
        });

        list.appendChild(item);
      });
      applyVisibility();
    }

    function applyVisibility(){
      const q = document.getElementById('search').value.trim().toLowerCase();
      const activeCatBtn = document.querySelector('.chip[data-active="true"]');
      const activeCat = activeCatBtn ? activeCatBtn.dataset.cat : 'all';

      const list = Array.from(document.querySelectorAll('#list .item'));
      list.forEach(el=>{
        const cat = el.dataset.cat;
        const name = el.querySelector('h4').textContent.toLowerCase();
        const meta = el.querySelector('.meta').textContent.toLowerCase();
        const matchCat = activeCat==='all' || cat===activeCat;
        const matchText = !q || name.includes(q) || meta.includes(q);
        el.classList.toggle('hidden', !(matchCat && matchText));
      });

      markersById.forEach((marker)=>{
        const p = marker.featureProps || {};
        const cat = marker.featureCat || 'other';
        const name = normText(p.name).toLowerCase();
        const desc = stripHtmlToText(p.description).toLowerCase();
        const matchCat = activeCat==='all' || cat===activeCat;
        const matchText = !q || name.includes(q) || desc.includes(q);
        const shouldShow = matchCat && matchText;
        if (shouldShow){
          if (!geoLayer.hasLayer(marker)) geoLayer.addLayer(marker);
        } else {
          if (geoLayer.hasLayer(marker)) geoLayer.removeLayer(marker);
        }
      });
    }

    /* События UI */
    document.getElementById('search').addEventListener('input', applyVisibility);
    document.querySelectorAll('.chip').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        document.querySelectorAll('.chip').forEach(b=>b.dataset.active='false');
        btn.dataset.active = 'true';
        applyVisibility();
      });
    });
    document.getElementById('btnShowAll').addEventListener('click', ()=>{
      if (boundsAll && boundsAll.isValid()) map.fitBounds(boundsAll, { padding:[20,20] });
    });
    document.getElementById('btnLocate').addEventListener('click', ()=> {
      document.querySelector('.leaflet-control-locate a')?.click();
    });
    document.getElementById('btnToggleSidebar').addEventListener('click', ()=>{
      const sb = document.getElementById('sidebar');
      sb.style.display = (sb.style.display === 'none') ? '' : 'none';
    });

    /* Загрузка KML (только относительные пути) */
    const kmlParam = new URLSearchParams(location.search).get('kml');
    const KML_CANDIDATES = [kmlParam, './doc.kml', 'doc.kml', '../doc.kml'].filter(Boolean);

    async function tryFetch(url){
      const r = await fetch(url, { cache: 'no-store' });
      if (!r.ok) throw new Error(`HTTP ${r.status} ${url}`);
      return r.text();
    }
    async function loadKmlAuto(){
      let lastErr;
      for (const url of KML_CANDIDATES){
        try {
          const raw = await tryFetch(url);
          const txt = sanitizeKmlString(raw);
          console.log('[KML] loaded from', url);
          return { txt, url };
        } catch(e){ lastErr = e; }
      }
      throw lastErr || new Error('KML not found');
    }

    function enableKmlPicker(){
      const bar = document.createElement('div');
      bar.style.cssText = 'position:absolute;z-index:1300;left:50%;transform:translateX(-50%);top:16px;background:var(--panel-bg);padding:8px 10px;border-radius:12px;border:1px solid var(--panel-border);box-shadow:var(--shadow);display:flex;gap:8px;align-items:center;font:14px system-ui';
      bar.innerHTML = `
        <span>Загрузить KML:</span>
        <input type="file" id="kmlFile" accept=".kml,.xml">
        <input type="text" id="kmlUrl" placeholder="или URL…" style="width:240px">
        <button class="btn">Загрузить</button>
      `;
      document.body.appendChild(bar);
      const btn = bar.querySelector('button');
      bar.querySelector('#kmlFile').addEventListener('change', e=>{
        const f = e.target.files?.[0]; if (!f) return;
        const fr = new FileReader();
        fr.onload = () => {
          const txt = sanitizeKmlString(String(fr.result));
          const kmlXml  = new DOMParser().parseFromString(txt,'application/xml');
          const styleHrefMap = buildStyleHrefMap(kmlXml);
          const geojson = toGeoJSON.kml(kmlXml);
          renderGeoJSON(geojson, styleHrefMap);
          bar.remove();
        };
        fr.readAsText(f);
      });
      btn.addEventListener('click', async ()=>{
        const url = bar.querySelector('#kmlUrl').value.trim();
        if (!url) return;
        try {
          const raw = await tryFetch(url);
          const txt = sanitizeKmlString(raw);
          const kmlXml  = new DOMParser().parseFromString(txt,'application/xml');
          const styleHrefMap = buildStyleHrefMap(kmlXml);
          const geojson = toGeoJSON.kml(kmlXml);
          renderGeoJSON(geojson, styleHrefMap);
          bar.remove();
        } catch(e){ alert('Не удалось загрузить по URL'); console.error(e); }
      });
    }

    (async ()=>{
      try {
        const { txt } = await loadKmlAuto();
        const kmlXml = new DOMParser().parseFromString(txt, 'application/xml');
        const styleHrefMap = buildStyleHrefMap(kmlXml);
        const geojson = toGeoJSON.kml(kmlXml);
        renderGeoJSON(geojson, styleHrefMap);
      } catch(e){
        console.error('KML load error:', e);
        enableKmlPicker();
        map.setView([41.6938,44.8015],14);
      }
    })();
  </script>
</body>
</html>
