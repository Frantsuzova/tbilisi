<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Мой маршрут Тбилиси</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.css" />
  <style>
    html, body, #map { height: 100%; margin: 0; padding: 0; }
  </style>
</head>
<body>
  <div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/@tmcw/togeojson@5.8.0/dist/togeojson.umd.js"></script>
<script src="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.js"></script>
<script>
  // --- Цветные булавки (фолбэк) ---
  const SHADOW = "https://cdn.jsdelivr.net/gh/pointhi/leaflet-color-markers@v1.0/img/marker-shadow.png";
  const IconBlue   = L.icon({ iconUrl: "https://cdn.jsdelivr.net/gh/pointhi/leaflet-color-markers@v1.0/img/marker-icon-2x-blue.png",   shadowUrl: SHADOW, iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[1,-34], shadowSize:[41,41] });
  const IconRed    = L.icon({ iconUrl: "https://cdn.jsdelivr.net/gh/pointhi/leaflet-color-markers@v1.0/img/marker-icon-2x-red.png",    shadowUrl: SHADOW, iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[1,-34], shadowSize:[41,41] });
  const IconGreen  = L.icon({ iconUrl: "https://cdn.jsdelivr.net/gh/pointhi/leaflet-color-markers@v1.0/img/marker-icon-2x-green.png",  shadowUrl: SHADOW, iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[1,-34], shadowSize:[41,41] });
  const IconYellow = L.icon({ iconUrl: "https://cdn.jsdelivr.net/gh/pointhi/leaflet-color-markers@v1.0/img/marker-icon-2x-yellow.png", shadowUrl: SHADOW, iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[1,-34], shadowSize:[41,41] });

  // --- Персональные иконки ---
  const ICONS = {
    basePath: 'icons/',     // Папка с иконками
    prefix: 'icon-',        // Имя файла до номера
    ext: 'png',             // Расширение
    count: 28,              // Сколько файлов
    size: [32, 32],         // Подстройте под реальные размеры PNG
    anchor: [16, 32],       // Точка "острия" — середина по X, низ по Y
    popupAnchor: [0, -28]
  };

  const personalIconCache = new Map();
  function personalIconById(id) {
    if (!id || id < 1 || id > ICONS.count) return null;
    if (personalIconCache.has(id)) return personalIconCache.get(id);
    const icon = L.icon({
      iconUrl: `${ICONS.basePath}${ICONS.prefix}${id}.${ICONS.ext}`,
      iconSize: ICONS.size,
      iconAnchor: ICONS.anchor,
      popupAnchor: ICONS.popupAnchor
    });
    personalIconCache.set(id, icon);
    return icon;
  }

  // — Нормализация текста
  function normText(v) {
    if (v == null) return "";
    if (typeof v === "string") return v;
    if (Array.isArray(v)) return v.map(normText).join(" ");
    if (typeof v === "object") return Object.values(v).map(normText).join(" ");
    return String(v);
  }

  // — Парс номера иконки из name/description
  function parseIconIdFromProps(p) {
    const text = (normText(p?.name) + ' ' + normText(p?.description)).toLowerCase();
    // шаблоны: "#12", "№12", "icon-12", "[12]"
    const m = text.match(/(?:#|№|\bicon-|\[)(\d{1,3})\b/);
    if (!m) return null;
    const n = parseInt(m[1], 10);
    return Number.isFinite(n) ? n : null;
  }

  // — Ваши цветовые правила как запасной вариант
  function fallbackColorIcon(feature) {
    const name = normText(feature?.properties?.name).toLowerCase();
    const desc = normText(feature?.properties?.description).toLowerCase();
    if (name.includes("лестниц") || desc.includes("лестниц")) return IconGreen;
    if (name.includes("парадн")  || desc.includes("парадн"))  return IconRed;
    if (name.includes("обсерватор") || desc.includes("обсерватор") ||
        name.includes("apollo") || name.includes("аполло"))    return IconYellow;
    return IconBlue;
  }

  // — Главная функция выбора иконки: персональная > фолбэк
  function chooseIcon(feature) {
    const p = feature.properties || {};
    // 1) Из текста
    let id = parseIconIdFromProps(p);
    // 2) Из порядка (если не указан)
    if (!id) {
      const seq = Number.isFinite(p._seq) ? (p._seq + 1) : null;
      if (seq) id = ((seq - 1) % ICONS.count) + 1;
    }
    const personal = personalIconById(id);
    return personal || fallbackColorIcon(feature);
  }

  // --- Карта ---
  const map = L.map('map');
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19, attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  L.control.locate({
    position:'topleft', setView:'untilPan', keepCurrentZoomLevel:true,
    strings:{ title:'Показать моё местоположение' }
  }).addTo(map);

  // --- Загрузка KML рядом как doc.kml ---
  fetch('doc.kml')
    .then(r => { if (!r.ok) throw new Error('HTTP ' + r.status); return r.text(); })
    .then(kmlText => {
      const kmlXml  = new DOMParser().parseFromString(kmlText, 'application/xml');
      const geojson = toGeoJSON.kml(kmlXml);

      // Пронумеруем фичи для стабильной последовательности
      if (Array.isArray(geojson.features)) {
        geojson.features.forEach((f, i) => {
          f.properties = Object.assign({}, f.properties, { _seq: i });
        });
      }

      const layer = L.geoJSON(geojson, {
        pointToLayer: (feature, latlng) => L.marker(latlng, { icon: chooseIcon(feature) }),
        style: { weight: 3 },
        onEachFeature: (feature, layer) => {
          const p = feature.properties || {};
          layer.bindPopup(`<strong>${normText(p.name)}</strong><br>${normText(p.description)}`);
        }
      }).addTo(map);

      try { map.fitBounds(layer.getBounds(), { padding:[20,20] }); }
      catch { map.setView([41.6938, 44.8015], 14); }
    })
    .catch(err => {
      console.error('KML load error:', err);
      map.setView([41.6938, 44.8015], 14);
      alert('Не удалось загрузить doc.kml. Проверь путь/имя файла.');
    });
</script>

</body>
</html>
